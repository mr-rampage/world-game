<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Game</title>
    <script>
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('src/cache.js')
            .then(() => {
              const countryActor = actor('src/country.actor.js', ({data: description}) => console.info(description));
              const villainActor = actor('src/villain.actor.js', clueHandler(witnessActors(), countryActor));
              villainActor.postMessage('flee');
            });
        });

        function actor(script, handler = () => {}) {
          const worker = new Worker(script);
          worker.addEventListener('message', handler);
          return worker;
        }

        function* witnessActors() {
          let workers = [];

          while (true) {
            const witnesses = yield workers;
            workers.forEach(worker => worker.terminate());
            workers = witnesses.map(() => actor('src/witness.actor.js'));
          }
        }

        function clueHandler(witnessActors, countryActor) {
          witnessActors.next(); // not sure why I need to call this first to get things primed
          return ({data: villain}) => {
            countryActor.postMessage(villain.destinations[0].name);
            witnessActors.next(villain.witnesses);
          };
        }
    </script>
</head>
<body>

</body>
</html>