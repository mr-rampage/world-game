<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>World Game</title>
    <script>
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('src/cache.js')
            .then(() => {
              const countryActor = new Worker('src/country.actor.js');
              countryActor.addEventListener('message', function({data: description}) {
                console.info(description)
              });

              const villainActor = new Worker('src/villain.actor.js');
              villainActor.addEventListener('message', onArrival(witnessActors(), countryActor));

              villainActor.postMessage('flee');
            });
        });

        function* witnessActors() {
          let workers = null;

          while (true) {
            let witnesses = yield workers;
            if (workers !== null) {
              workers.forEach(worker => worker.terminate());
            }
            workers = witnesses.map(() => new Worker('src/witness.actor.js'));
          }
        }

        function onArrival(witnessActors, countryActor) {
          witnessActors.next(); // not sure why I need to call this first to get things primed
          return ({data: villain}) => {
            countryActor.postMessage(villain.destinations[0].name);
            console.info('onArrival', witnessActors.next(villain.witnesses).value);
          };
        }
    </script>
</head>
<body>

</body>
</html>